<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Step 2: Project & Dataset - Nginx Stress-Test</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff; --bg-secondary: #f8fafc; --bg-tertiary: #f1f5f9; --bg-card: #ffffff;
            --accent-primary: #0ea5e9; --accent-secondary: #6366f1; --accent-success: #10b981; --accent-warning: #f59e0b; --accent-error: #ef4444;
            --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #94a3b8;
            --border-color: #e2e8f0;
            --gradient-1: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05); --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg-secondary); color: var(--text-primary); min-height: 100vh; }
        .container { max-width: 1100px; margin: 0 auto; padding: 40px 24px; }
        .breadcrumb { display: flex; gap: 8px; margin-bottom: 32px; font-size: 14px; color: var(--text-muted); }
        .breadcrumb a { color: var(--accent-primary); text-decoration: none; }
        .page-header { display: flex; align-items: center; gap: 20px; margin-bottom: 40px; }
        .step-badge { width: 64px; height: 64px; background: var(--gradient-1); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; color: white; }
        .page-title h1 { font-size: 32px; font-weight: 700; margin-bottom: 4px; }
        .page-title p { font-size: 16px; color: var(--text-secondary); }
        .flow-nav { display: flex; justify-content: center; gap: 8px; margin-bottom: 40px; flex-wrap: wrap; }
        .nav-pill { padding: 8px 16px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 100px; color: var(--text-secondary); text-decoration: none; font-weight: 500; font-size: 12px; box-shadow: var(--shadow-sm); }
        .nav-pill:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .nav-pill.active { background: var(--gradient-1); border-color: transparent; color: white; }

        .card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 28px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
        .card h2 { font-size: 18px; margin-bottom: 20px; color: var(--text-primary); }

        .info-box { background: rgba(14, 165, 233, 0.08); border: 1px solid var(--accent-primary); border-radius: 12px; padding: 16px; margin-top: 16px; }
        .info-box p { font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .info-box p:last-child { margin-bottom: 0; }
        .info-box strong { color: var(--accent-primary); }
        .info-box a { color: var(--accent-primary); text-decoration: none; }
        .info-box a:hover { text-decoration: underline; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 14px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary); }
        .form-group input, .form-group select { width: 100%; padding: 10px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-family: inherit; }
        .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--accent-primary); }
        .form-group small { display: block; margin-top: 6px; font-size: 12px; color: var(--text-muted); }

        .btn { padding: 12px 24px; border-radius: 10px; font-size: 14px; font-weight: 600; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--gradient-1); color: white; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--accent-primary); color: var(--accent-primary); }

        .status-message { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 14px; }
        .status-message.success { background: rgba(16, 185, 129, 0.1); border: 1px solid var(--accent-success); color: #065f46; }
        .status-message.error { background: rgba(239, 68, 68, 0.1); border: 1px solid var(--accent-error); color: #991b1b; }
        .status-message.info { background: rgba(14, 165, 233, 0.1); border: 1px solid var(--accent-primary); color: #0c4a6e; }

        .list-item { padding: 12px 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .list-item-name { font-weight: 600; color: var(--text-primary); }
        .list-item-id { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted); }
        .list-item-actions { display: flex; gap: 8px; }
        .btn-small { padding: 6px 12px; font-size: 12px; }

        .loading { display: inline-block; width: 16px; height: 16px; border: 2px solid var(--border-color); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 24px; border-top: 1px solid var(--border-color); }

        .copy-toast { position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px); z-index: 10000; padding: 12px 20px; border-radius: 10px; font-size: 14px; font-weight: 500; color: white; background: var(--gradient-1); box-shadow: var(--shadow-md); opacity: 0; transition: transform 0.25s ease, opacity 0.25s ease; pointer-events: none; max-width: 90%; text-align: center; }
        .copy-toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .copy-toast.error { background: var(--accent-error); }
        .copy-toast .toast-id { display: block; margin-top: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; word-break: break-all; user-select: all; -webkit-user-select: all; cursor: text; background: rgba(0,0,0,0.2); padding: 6px 10px; border-radius: 6px; pointer-events: auto; }
    </style>
</head>
<body>
    <div class="container" style="height: 100vh; overflow-y: scroll;">
        <div class="breadcrumb">
            <a href="index.html">Overview</a><span>‚Ä∫</span><span>Step 2: Project & Dataset</span>
        </div>
        <div class="page-header">
            <div class="step-badge">2</div>
            <div class="page-title">
                <h1>Project & Dataset</h1>
                <p>Create faasProxy storage driver for your project</p>
            </div>
        </div>
        <nav class="flow-nav">
            <a href="index.html" class="nav-pill">Overview</a>
            <a href="step1-compute-setup.html" class="nav-pill">Compute Setup</a>
            <a href="step2-project.html" class="nav-pill active">Project & Dataset</a>
            <a href="step3-download-images.html" class="nav-pill">Download Images</a>
            <a href="step4-link-items.html" class="nav-pill">Link Items</a>
            <a href="step5-pipeline.html" class="nav-pill">Pipeline</a>
            <a href="step6-execute.html" class="nav-pill">Execute</a>
        </nav>

        <div class="card">
            <h2>faasProxy Storage Driver</h2>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                The faasProxy driver is built as a layer above the GCS driver and is needed to store JSON files. 
                It allows datasets to reference files stored in FaaS Storage without copying them (using link items).
            </p>
            <div class="info-box">
                <p><strong>Prerequisites:</strong></p>
                <p>‚Ä¢ You need a GCS integration or Cloud Workload Identity Federation integration in your organization</p>
                <p>‚Ä¢ Supported integration types: <code>gcs</code>, <code>gcp-workload-identity-federation</code></p>
                <p>‚Ä¢ See Dataloop documentation: <a href="https://developers.dataloop.ai/tutorials/data_management/external_storage_drivers/gcs/chapter" target="_blank">GCS Integration Guide</a></p>
                <p>‚Ä¢ <a href="https://docs.dataloop.ai/docs/cross-project-integration" target="_blank">Cross-Project Integration</a> (recommended), <a href="https://docs.dataloop.ai/docs/private-key-integration" target="_blank">Private Key Integration</a>, or <a href="https://docs.dataloop.ai/docs/workload-identity-federation" target="_blank">Workload Identity Federation</a></p>
            </div>
        </div>

        <div id="orgAccessChecking" class="card" style="text-align: center; padding: 32px;">
            <div class="loading" style="margin: 0 auto 16px;"></div>
            <p style="color: var(--text-secondary);">Checking organization access...</p>
        </div>

        <div id="noOrgPermissionSection" class="card" style="display: none;">
            <h2>Organization permission required</h2>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                This service runs as a user or bot that does not have organization-level permission. 
                To create integrations and drivers from this UI, add the service identity to your organization with the required permissions.
            </p>
            <div class="info-box" style="background: rgba(245, 158, 11, 0.1); border-color: var(--accent-warning);">
                <p><strong>Organization</strong></p>
                <p id="noPermOrgName" style="font-family: 'JetBrains Mono', monospace; font-size: 14px; margin-top: 8px;">‚Äî</p>
                <p id="noPermOrgId" style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">‚Äî</p>
                <p style="margin-top: 12px;"><strong>Service bot (add this to your org):</strong></p>
                <p id="noPermBotUserName" style="font-family: 'JetBrains Mono', monospace; font-size: 14px; margin-top: 4px; font-weight: 600;">‚Äî</p>
                <p id="noPermIdentityFallback" style="font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--text-muted); margin-top: 4px; display: none;">‚Äî</p>
                <p style="margin-top: 16px;">Add the service bot above to the organization with permissions to create integrations and storage drivers. The bot must be set as <strong>admin</strong> on the org in order to get the permission to create the driver. <a id="orgMembersLink" href="#" target="_blank" rel="noopener noreferrer">Open org members</a> to add it. Then refresh this page.</p>
            </div>
            <div class="info-box" style="margin-top: 16px; background: rgba(16, 185, 129, 0.08); border-color: var(--accent-success);">
                <p><strong>Alternative: run the script locally</strong></p>
                <p>If you cannot grant org permission to the service, clone the project and run the script on your machine (with your own credentials):</p>
                <p style="font-family: 'JetBrains Mono', monospace; font-size: 12px; background: var(--bg-tertiary); padding: 10px; border-radius: 4px; margin-top: 8px; white-space: pre-wrap;"># Check existing drivers
python check_faas_proxy_drivers.py --project-name "your-project"

# Create a new driver (interactive)
python create_faas_proxy_driver.py</p>
                <p style="margin-top: 8px;">Scripts on GitHub: <a href="https://github.com/zvi-dataloop/stress-test-flows/blob/main/create_faas_proxy_driver.py" target="_blank" rel="noopener noreferrer">create_faas_proxy_driver.py</a>, <a href="https://github.com/zvi-dataloop/stress-test-flows/blob/main/check_faas_proxy_drivers.py" target="_blank" rel="noopener noreferrer">check_faas_proxy_drivers.py</a></p>
            </div>
        </div>

        <div id="driverSection" style="display: none;">
        <div class="card">
            <h2>Check Existing Drivers</h2>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 16px;">
                Check if a faasProxy driver already exists in your project.
            </p>
            <button type="button" class="btn btn-secondary" onclick="loadDrivers()">üîÑ Refresh Drivers List</button>
            <div id="driversList" style="margin-top: 16px;"></div>
        </div>

        <div class="card">
            <h2>Create faasProxy Driver</h2>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 20px;">
                Create a new faasProxy storage driver. You can use an existing GCS integration or create a new one.
            </p>
            
            <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px; cursor: pointer;">
                    <input type="radio" name="integrationMode" value="select" checked onchange="toggleIntegrationMode()" style="width: auto;">
                    <span>Select from list (if available)</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="radio" name="integrationMode" value="manual" onchange="toggleIntegrationMode()" style="width: auto;">
                    <span>Enter Integration ID manually</span>
                </label>
            </div>

            <div id="integrationSelectMode" style="margin-bottom: 20px;">
                <button type="button" class="btn btn-secondary" onclick="loadIntegrations()" style="margin-bottom: 16px;">üîÑ Load GCS Integrations</button>
                <div id="integrationsList" style="margin-bottom: 20px;"></div>
            </div>

            <div id="integrationManualMode" style="display: none; margin-bottom: 20px;">
                <div class="info-box">
                    <p><strong>Note:</strong> FaaS services don't have access to read organization-level integrations.</p>
                    <p>If you know your GCS integration ID, enter it manually below.</p>
                </div>
            </div>

            <div id="statusMessage"></div>

            <form id="driverForm" novalidate>
                <div class="form-group">
                    <label for="driverName">Driver Name *</label>
                    <input type="text" id="driverName" required placeholder="e.g., faas-proxy-driver">
                </div>

                <div class="form-group" id="integrationSelectGroup">
                    <label for="integrationId">GCS Integration *</label>
                    <select id="integrationId">
                        <option value="">Select an integration...</option>
                    </select>
                    <small>Select an existing GCS integration from the list above</small>
                </div>

                <div id="integrationManualGroup" style="display: none;">
                    <div class="form-group">
                        <label for="integrationTypeManual">Integration Type *</label>
                        <select id="integrationTypeManual" required>
                            <option value="">Select integration type...</option>
                            <option value="gcs">gcs</option>
                            <option value="gcp-workload-identity-federation">gcp-workload-identity-federation</option>
                        </select>
                        <small>Select the type of GCS integration you're using</small>
                    </div>
                    <div class="form-group">
                        <label for="integrationIdManual">GCS Integration ID *</label>
                        <input type="text" id="integrationIdManual" placeholder="e.g., ed2536b0-78de-4eb0-b79b-dc0cb864823b">
                        <small>Enter your GCS integration ID (you can find it in the Dataloop platform or by running the script locally)</small>
                    </div>
                </div>

                <div class="form-group">
                    <label for="bucketName">GCS Bucket Name *</label>
                    <input type="text" id="bucketName" required placeholder="e.g., my-gcs-bucket">
                </div>

                <div class="form-group">
                    <label for="path">Path (Optional)</label>
                    <input type="text" id="path" placeholder="e.g., folder/subfolder (leave empty for root)">
                    <small>Optional path within the bucket</small>
                </div>

                <div class="form-group">
                    <label>
                        <input type="checkbox" id="allowExternalDelete" checked style="width: auto; margin-right: 8px;">
                        Allow External Delete
                    </label>
                    <small>Allow deleting items from storage through Dataloop platform</small>
                </div>

                <button type="button" class="btn btn-primary" id="createBtn">üöÄ Create faasProxy Driver</button>
            </form>

            <div id="driverResult" style="margin-top: 20px;"></div>
        </div>
        </div>

        <div class="nav-buttons">
            <a href="step1-compute-setup.html" class="btn btn-secondary">‚Üê Back to Compute Setup</a>
            <a href="step3-download-images.html" class="btn btn-primary">Next: Download Images ‚Üí</a>
        </div>
    </div>

    <script>
        let integrations = [];
        let drivers = [];

        async function loadIntegrations() {
            const listDiv = document.getElementById('integrationsList');
            listDiv.innerHTML = '<div class="loading"></div> Loading integrations...';
            
            try {
                const response = await fetch('/api/gcs-integrations');
                const data = await response.json();
                
                if (data.success && data.integrations.length > 0) {
                    integrations = data.integrations;
                    let html = '<h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">Available GCS Integrations:</h3>';
                    data.integrations.forEach(int => {
                        html += `
                            <div class="list-item">
                                <div>
                                    <div class="list-item-name">${int.name}</div>
                                    <div class="list-item-id">ID: ${int.id}</div>
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                    
                    // Populate select dropdown
                    const select = document.getElementById('integrationId');
                    select.innerHTML = '<option value="">Select an integration...</option>';
                    data.integrations.forEach(int => {
                        const option = document.createElement('option');
                        option.value = int.id;
                        option.textContent = `${int.name} (${int.id.substring(0, 8)}...)`;
                        select.appendChild(option);
                    });
                } else {
                    listDiv.innerHTML = '<div class="status-message info">No GCS integrations found. Please create one first. See documentation links above.</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="status-message error">Error loading integrations: ${error.message}</div>`;
            }
        }

        async function loadDrivers() {
            const listDiv = document.getElementById('driversList');
            listDiv.innerHTML = '<div class="loading"></div> Loading drivers...';
            
            try {
                const response = await fetch('/api/faas-proxy-drivers');
                const data = await response.json();
                
                if (data.success && data.drivers.length > 0) {
                    drivers = data.drivers;
                    let html = '<h3 style="font-size: 14px; margin-bottom: 12px; color: var(--text-primary);">Existing faasProxy Drivers:</h3>';
                    data.drivers.forEach(driver => {
                        html += `
                            <div class="list-item">
                                <div>
                                    <div class="list-item-name">${driver.name}</div>
                                    <div class="list-item-id">ID: ${driver.id} | Bucket: ${driver.bucket || 'N/A'}</div>
                                </div>
                                <div class="list-item-actions">
                                    <button class="btn btn-small btn-secondary" data-driver-id="${(driver.id + '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}" onclick="copyDriverId(this.getAttribute('data-driver-id'))">Copy ID</button>
                                </div>
                            </div>
                        `;
                    });
                    listDiv.innerHTML = html;
                } else {
                    listDiv.innerHTML = '<div class="status-message info">No faasProxy drivers found in this project.</div>';
                }
            } catch (error) {
                listDiv.innerHTML = `<div class="status-message error">Error loading drivers: ${error.message}</div>`;
            }
        }

        function toggleIntegrationMode() {
            const mode = document.querySelector('input[name="integrationMode"]:checked').value;
            const selectMode = document.getElementById('integrationSelectMode');
            const manualMode = document.getElementById('integrationManualMode');
            const selectGroup = document.getElementById('integrationSelectGroup');
            const manualGroup = document.getElementById('integrationManualGroup');
            const selectField = document.getElementById('integrationId');
            const manualField = document.getElementById('integrationIdManual');
            const manualTypeField = document.getElementById('integrationTypeManual');
            
            if (mode === 'manual') {
                selectMode.style.display = 'none';
                manualMode.style.display = 'block';
                selectGroup.style.display = 'none';
                manualGroup.style.display = 'block';
                selectField.removeAttribute('required');
                manualField.setAttribute('required', 'required');
                manualTypeField.setAttribute('required', 'required');
            } else {
                selectMode.style.display = 'block';
                manualMode.style.display = 'none';
                selectGroup.style.display = 'block';
                manualGroup.style.display = 'none';
                manualField.removeAttribute('required');
                manualTypeField.removeAttribute('required');
                selectField.setAttribute('required', 'required');
            }
        }

        function showCopyToast(message, isError) {
            let toast = document.getElementById('copyToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'copyToast';
                toast.className = 'copy-toast';
                document.body.appendChild(toast);
            }
            toast.innerHTML = '';
            toast.appendChild(document.createTextNode(message));
            toast.classList.toggle('error', !!isError);
            toast.classList.add('show');
            clearTimeout(showCopyToast._tid);
            showCopyToast._tid = setTimeout(() => {
                toast.classList.remove('show');
            }, 2500);
        }

        function showCopyToastWithId(message, driverId) {
            let toast = document.getElementById('copyToast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'copyToast';
                toast.className = 'copy-toast';
                document.body.appendChild(toast);
            }
            const idEl = document.createElement('span');
            idEl.className = 'toast-id';
            idEl.textContent = driverId;
            toast.innerHTML = '';
            toast.appendChild(document.createTextNode(message));
            toast.appendChild(idEl);
            toast.classList.add('error', 'show');
            toast.style.pointerEvents = 'auto';
            clearTimeout(showCopyToast._tid);
            showCopyToast._tid = setTimeout(() => {
                toast.classList.remove('show');
                toast.style.pointerEvents = '';
            }, 5000);
        }

        function copyDriverId(driverId) {
            if (!driverId) return;
            try { window.focus(); } catch (e) {}
            const copy = () => {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    return navigator.clipboard.writeText(driverId).then(() => true);
                }
                return Promise.resolve(false);
            };
            const copyFallback = () => {
                const ta = document.createElement('textarea');
                ta.value = driverId;
                ta.setAttribute('readonly', '');
                ta.style.position = 'fixed';
                ta.style.left = '0';
                ta.style.top = '0';
                ta.style.width = '2em';
                ta.style.height = '2em';
                ta.style.padding = '0';
                ta.style.border = 'none';
                ta.style.outline = 'none';
                ta.style.boxShadow = 'none';
                ta.style.background = 'transparent';
                ta.style.opacity = '0';
                ta.setAttribute('aria-hidden', 'true');
                document.body.appendChild(ta);
                ta.focus();
                ta.select();
                ta.setSelectionRange(0, driverId.length);
                let ok = false;
                try {
                    ok = document.execCommand('copy');
                } finally {
                    document.body.removeChild(ta);
                }
                return ok;
            };
            copy()
                .then(done => {
                    if (done) {
                        showCopyToast('Driver ID copied to clipboard');
                        return;
                    }
                    if (copyFallback()) {
                        showCopyToast('Driver ID copied to clipboard');
                    } else {
                        showCopyToastWithId('Could not copy to clipboard. Select and copy:', driverId);
                    }
                })
                .catch(() => {
                    if (copyFallback()) {
                        showCopyToast('Driver ID copied to clipboard');
                    } else {
                        showCopyToastWithId('Could not copy to clipboard. Select and copy:', driverId);
                    }
                });
        }

        async function createDriver(event) {
            if (event && event.preventDefault) event.preventDefault();
            
            const createBtn = document.getElementById('createBtn');
            const statusDiv = document.getElementById('statusMessage');
            const resultDiv = document.getElementById('driverResult');
            
            createBtn.disabled = true;
            createBtn.innerHTML = '<span class="loading"></span> Creating...';
            statusDiv.innerHTML = '';
            resultDiv.innerHTML = '';
            
            // Get integration ID and type based on selected mode
            const mode = document.querySelector('input[name="integrationMode"]:checked').value;
            let integrationId, integrationType;
            
            if (mode === 'manual') {
                integrationId = document.getElementById('integrationIdManual').value.trim();
                integrationType = document.getElementById('integrationTypeManual').value;
                
                if (!integrationId || !integrationType) {
                    statusDiv.innerHTML = '<div class="status-message error">‚úó Please provide both Integration Type and Integration ID</div>';
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'üöÄ Create faasProxy Driver';
                    return;
                }
            } else {
                integrationId = document.getElementById('integrationId').value;
                integrationType = null; // Will be determined from the selected integration
                
                if (!integrationId) {
                    statusDiv.innerHTML = '<div class="status-message error">‚úó Please select a GCS Integration</div>';
                    createBtn.disabled = false;
                    createBtn.innerHTML = 'üöÄ Create faasProxy Driver';
                    return;
                }
            }
            
            const formData = {
                driverName: document.getElementById('driverName').value,
                integrationId: integrationId,
                integrationType: integrationType,
                bucketName: document.getElementById('bucketName').value,
                path: document.getElementById('path').value || null,
                allowExternalDelete: document.getElementById('allowExternalDelete').checked
            };
            
            try {
                const response = await fetch('/api/create-faas-proxy-driver', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = `<div class="status-message success">‚úì ${data.exists ? 'Driver already exists' : 'Driver created successfully'}!</div>`;
                    resultDiv.innerHTML = `
                        <div class="info-box">
                            <p><strong>Driver ID:</strong> <code style="font-family: 'JetBrains Mono', monospace; background: var(--bg-tertiary); padding: 4px 8px; border-radius: 4px;">${data.driver.id}</code></p>
                            <p><strong>Driver Name:</strong> ${data.driver.name}</p>
                            <p><strong>Bucket:</strong> ${data.driver.bucket}</p>
                            <p style="margin-top: 12px;">Use this Driver ID when creating datasets in the workflow.</p>
                            <button class="btn btn-small btn-primary" data-driver-id="${(data.driver.id + '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}" onclick="copyDriverId(this.getAttribute('data-driver-id'))" style="margin-top: 8px;">Copy Driver ID</button>
                        </div>
                    `;
                    
                    // Reload drivers list
                    loadDrivers();
                } else {
                    const errText = (data.error || data.message || 'Unknown error').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
                    statusDiv.innerHTML = `<div class="status-message error">‚úó Error: ${errText}</div>`;
                }
            } catch (error) {
                statusDiv.innerHTML = `<div class="status-message error">‚úó Error: ${error.message}</div>`;
            } finally {
                createBtn.disabled = false;
                createBtn.innerHTML = 'üöÄ Create faasProxy Driver';
            }
        }

        async function checkOrgAccess() {
            const checkingEl = document.getElementById('orgAccessChecking');
            const noPermEl = document.getElementById('noOrgPermissionSection');
            const driverEl = document.getElementById('driverSection');
            
            try {
                const response = await fetch('/api/org-access');
                const data = await response.json();
                
                checkingEl.style.display = 'none';
                
                if (data.hasOrgPermission) {
                    driverEl.style.display = 'block';
                    loadIntegrations();
                    loadDrivers();
                } else {
                    noPermEl.style.display = 'block';
                    document.getElementById('noPermOrgName').textContent = data.orgName || '‚Äî';
                    document.getElementById('noPermOrgId').textContent = data.orgId ? 'ID: ' + data.orgId : '‚Äî';
                    var orgMembersLink = document.getElementById('orgMembersLink');
                    if (orgMembersLink && data.orgMembersUrl) {
                        orgMembersLink.href = data.orgMembersUrl;
                        orgMembersLink.style.display = 'inline';
                    } else if (orgMembersLink) {
                        orgMembersLink.style.display = 'none';
                    }
                    var botUserName = data.botUserName || data.bot_user_name;
                    var identityFallback = data.currentIdentity;
                    var botEl = document.getElementById('noPermBotUserName');
                    var fallbackEl = document.getElementById('noPermIdentityFallback');
                    if (botUserName) {
                        botEl.textContent = botUserName;
                        botEl.style.display = 'block';
                        fallbackEl.style.display = 'none';
                    } else if (identityFallback) {
                        botEl.textContent = identityFallback;
                        botEl.style.display = 'block';
                        fallbackEl.style.display = 'none';
                    } else {
                        botEl.textContent = 'Unknown (check service has botUserName set)';
                        botEl.style.display = 'block';
                        fallbackEl.style.display = 'none';
                    }
                }
            } catch (error) {
                checkingEl.style.display = 'none';
                noPermEl.style.display = 'block';
                document.getElementById('noPermOrgName').textContent = '‚Äî';
                document.getElementById('noPermOrgId').textContent = 'Could not load org (check project is set)';
                document.getElementById('noPermBotUserName').textContent = '‚Äî';
                document.getElementById('noPermIdentityFallback').style.display = 'none';
                var orgMembersLink = document.getElementById('orgMembersLink');
                if (orgMembersLink) orgMembersLink.style.display = 'none';
            }
        }

        // Check org access first, then show driver UI or no-permission message
        window.addEventListener('DOMContentLoaded', () => {
            checkOrgAccess();
            // Attach Create button click so the request is always sent (no reliance on form submit)
            var createBtn = document.getElementById('createBtn');
            var driverForm = document.getElementById('driverForm');
            if (createBtn) {
                createBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    createDriver(e);
                });
            }
            if (driverForm) {
                driverForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    createDriver(e);
                });
            }
        });
    </script>
</body>
</html>
